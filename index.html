<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Gotcha!</title>
    <link rel="shortcut icon" type="image/png" href="res/favicon.png" />
    <script src="leaflet/leaflet.js"></script>
    <link href="leaflet/leaflet.css" rel="stylesheet" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      #mymap {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="mymap"></div>
  </body>

  <script>
    var LeafIcon = L.Icon.extend({
      options: {
        iconSize: [35, 55],
        shadowSize: [0, 0],
        iconAnchor: [17, 55],
        shadowAnchor: [0, 0],
        popupAnchor: [-3, -76],
      },
    });

    var baseIcon = new LeafIcon({
      iconUrl: "res/baseIcon.png",
    });

    var workerIcon = new LeafIcon({
      iconUrl: "res/workerIcon.png",
    });

    var mymap = L.map("mymap", {
      minZoom: 9,
      maxZoom: 16,
    });

    mymap.setView([42.39379, -72.528574], 14);

    L.TileLayer.Custom = L.TileLayer.extend({
      getTileUrl: function (coords) {
        url = "./tiles/" + coords.z + "/" + coords.x + "/" + coords.y + ".png";
        return url;
      },
    });

    L.tileLayer.Custom = function () {
      return new L.TileLayer.Custom();
    };
    L.tileLayer.Custom().addTo(mymap);

    var nodeMarkers = L.layerGroup().addTo(mymap);

    function updateMarkers() {
      nodeMarkers.clearLayers();

      // print markers
      var request = new XMLHttpRequest();
      request.open("GET", "data.json", false);
      request.send(null);
      var markerDB = JSON.parse(request.responseText);

      // worker nodes
      for (var i = 0; i < markerDB["worker_id"].length; i++) {
        var newMarker = L.marker(
          [markerDB["worker_lat"][i], markerDB["worker_lon"][i]],
          { icon: workerIcon }
        );
        newMarker.addTo(nodeMarkers);
        newMarker.bindPopup(
          "<h3>Person Seeking Rescue</h3><span><strong>ID</strong> " +
            markerDB["worker_id"][i] +
            "<br><strong>Lat</strong> " +
            markerDB["worker_lat"][i] +
            "<br><strong>Lon</strong> " +
            markerDB["worker_lon"][i]
        );
      }

      // base nodes
      for (var i = 0; i < markerDB["base_id"].length; i++) {
        var newMarker = L.marker(
          [markerDB["base_lat"][i], markerDB["base_lon"][i]],
          { icon: baseIcon }
        );
        newMarker.addTo(nodeMarkers);
        newMarker.bindPopup(
          "<h3>Base Station</h3><span><strong>ID</strong> " +
            markerDB["base_id"][i] +
            "<br><strong>Lat</strong> " +
            markerDB["base_lat"][i] +
            "<br><strong>Lon</strong> " +
            markerDB["base_lon"][i]
        );
      }
    }

    updateMarkers();

    // update markers every 10 seconds
    setInterval(function () {
      updateMarkers();
    }, 10000);
  </script>
</html>
